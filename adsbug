import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np

# è¨­å®šä¸­æ–‡å­—å‹ï¼Œä»¥å…åœ–è¡¨äº‚ç¢¼ (Windows ä½¿ç”¨ 'Microsoft JhengHei', Mac ä½¿ç”¨ 'Arial Unicode MS')
plt.rcParams['font.sans-serif'] = ['Microsoft JhengHei'] 
plt.rcParams['axes.unicode_minus'] = False

def clean_numeric(x):
    """
    è³‡æ–™æ¸…æ´—å‡½æ•¸ï¼š
    è™•ç† Meta å ±è¡¨ä¸­å¸¸è¦‹çš„æ ¼å¼ï¼Œå¦‚ "1,234" (å­—ä¸²è½‰æ•¸å­—)ã€"-" (è½‰ç‚º 0)
    """
    if isinstance(x, str):
        x = x.replace(',', '').replace('%', '')
        if x.strip() == '-':
            return 0
    return pd.to_numeric(x, errors='coerce')

def detect_anomalies(file_path):
    print(f"æ­£åœ¨è®€å–æª”æ¡ˆ: {file_path}...")
    
    # 1. è®€å–èˆ‡å‰è™•ç†
    try:
        df = pd.read_csv(file_path)
    except Exception as e:
        print(f"è®€å–éŒ¯èª¤: {e}")
        return

    # å®šç¾©éœ€è¦æ•¸å€¼åŒ–çš„é—œéµæ¬„ä½ (è«‹æ ¹æ“šæ‚¨çš„å ±è¡¨å¯¦éš›æ¬„ä½åç¨±èª¿æ•´)
    numeric_cols = [
        'CTRï¼ˆé€£çµé»é–±ç‡ï¼‰', 'æ›å…‰æ¬¡æ•¸', 'é€£çµé»æ“Šæ¬¡æ•¸', 
        'é€£çµé é¢ç€è¦½æ¬¡æ•¸', 'CPMï¼ˆæ¯åƒæ¬¡å»£å‘Šæ›å…‰æˆæœ¬ï¼‰'
    ]
    
    # æª¢æŸ¥æ¬„ä½æ˜¯å¦å­˜åœ¨
    missing_cols = [col for col in numeric_cols if col not in df.columns]
    if missing_cols:
        print(f"è­¦å‘Šï¼šæ‰¾ä¸åˆ°ä»¥ä¸‹æ¬„ä½ï¼Œè«‹æª¢æŸ¥ CSV æ¬„ä½åç¨±: {missing_cols}")
        return

    for col in numeric_cols:
        df[col] = df[col].apply(clean_numeric)
    
    # éæ¿¾æ‰æ¥µå°æµé‡çš„é›œè¨Š (ä¾‹å¦‚æ›å…‰ < 50)
    df_clean = df[df['æ›å…‰æ¬¡æ•¸'] > 50].copy()
    
    # è¨ˆç®—é—œéµæŒ‡æ¨™ï¼šè½åœ°é ç€è¦½ç‡ (Quality Ratio)
    # é¿å…åˆ†æ¯ç‚º 0
    df_clean['LP_View_Rate'] = df_clean.apply(
        lambda row: row['é€£çµé é¢ç€è¦½æ¬¡æ•¸'] / row['é€£çµé»æ“Šæ¬¡æ•¸'] if row['é€£çµé»æ“Šæ¬¡æ•¸'] > 0 else 0, axis=1
    )

    # ---------------------------------------------------------
    # 2. æ ¸å¿ƒåµæ¸¬é‚è¼¯ (Anomaly Detection Logic)
    # ---------------------------------------------------------
    
    # [é‚è¼¯ A] å¹½éˆé»æ“Š (Ghost Clicks): é«˜ CTR ä½†ä½åˆ°é ç‡
    # é–¾å€¼è¨­å®šï¼šCTR > 4% ä¸” åˆ°é ç‡ < 50%
    ghost_clicks = df_clean[
        (df_clean['CTRï¼ˆé€£çµé»é–±ç‡ï¼‰'] > 4) & 
        (df_clean['LP_View_Rate'] < 0.5)
    ].sort_values(by='CTRï¼ˆé€£çµé»é–±ç‡ï¼‰', ascending=False)

    # [é‚è¼¯ B] å±•ç¤ºçŒæ°´ (Impression Flooding): æ¥µé«˜æ›å…‰ä½†ä½ CTR
    # é–¾å€¼è¨­å®šï¼šæ›å…‰å¤§æ–¼ PR75 (å‰ 25% é«˜æµé‡) ä¸” CTR < 1.5%
    high_imp_threshold = df_clean['æ›å…‰æ¬¡æ•¸'].quantile(0.75)
    flooding = df_clean[
        (df_clean['æ›å…‰æ¬¡æ•¸'] > high_imp_threshold) & 
        (df_clean['CTRï¼ˆé€£çµé»é–±ç‡ï¼‰'] < 1.5)
    ].sort_values(by='æ›å…‰æ¬¡æ•¸', ascending=False)

    # ---------------------------------------------------------
    # 3. è¼¸å‡ºå ±å‘Š
    # ---------------------------------------------------------
    print("\n" + "="*50)
    print("ğŸš¨ [ç•°å¸¸åµæ¸¬ A] ç–‘ä¼¼å¹½éˆé»æ“Š/æ©Ÿå™¨äºº (High CTR, Low Quality)")
    print("="*50)
    if not ghost_clicks.empty:
        cols_show = ['å¤©æ•¸', 'å»£å‘Šåç¨±', 'æ›å…‰æ¬¡æ•¸', 'é€£çµé»æ“Šæ¬¡æ•¸', 'é€£çµé é¢ç€è¦½æ¬¡æ•¸', 'CTRï¼ˆé€£çµé»é–±ç‡ï¼‰', 'LP_View_Rate']
        print(ghost_clicks[cols_show].to_string(index=False))
    else:
        print("æœªç™¼ç¾é¡¯è‘—ç•°å¸¸ã€‚")

    print("\n" + "="*50)
    print(f"ğŸš¨ [ç•°å¸¸åµæ¸¬ B] ç–‘ä¼¼å±•ç¤ºçŒæ°´ (Impression Flooding, Imp > {int(high_imp_threshold)})")
    print("="*50)
    if not flooding.empty:
        cols_show = ['å¤©æ•¸', 'å»£å‘Šåç¨±', 'æ›å…‰æ¬¡æ•¸', 'CTRï¼ˆé€£çµé»é–±ç‡ï¼‰', 'CPMï¼ˆæ¯åƒæ¬¡å»£å‘Šæ›å…‰æˆæœ¬ï¼‰']
        print(flooding[cols_show].to_string(index=False))
    else:
        print("æœªç™¼ç¾é¡¯è‘—ç•°å¸¸ã€‚")

    # ---------------------------------------------------------
    # 4. è¦–è¦ºåŒ–è¨ºæ–·åœ– (ä¿å­˜ç‚ºåœ–ç‰‡)
    # ---------------------------------------------------------
    plt.figure(figsize=(14, 6))

    # å·¦åœ–ï¼šå“è³ªè¨ºæ–·
    plt.subplot(1, 2, 1)
    sns.scatterplot(data=df_clean, x='é€£çµé»æ“Šæ¬¡æ•¸', y='é€£çµé é¢ç€è¦½æ¬¡æ•¸', 
                    hue='CTRï¼ˆé€£çµé»é–±ç‡ï¼‰', size='æ›å…‰æ¬¡æ•¸', sizes=(20, 200), palette='viridis')
    # ç•«å‡º 1:1 å®Œç¾è½‰æ›ç·š
    limit = df_clean['é€£çµé»æ“Šæ¬¡æ•¸'].max()
    plt.plot([0, limit], [0, limit], 'r--', label='1:1 Perfect Line')
    plt.title('é»æ“Šå“è³ªè¨ºæ–· (åé›¢ç´…ç·šè¶Šé è¶Šå±éšª)')
    plt.legend()

    # å³åœ–ï¼šæµé‡è¨ºæ–·
    plt.subplot(1, 2, 2)
    sns.scatterplot(data=df_clean, x='æ›å…‰æ¬¡æ•¸', y='CTRï¼ˆé€£çµé»é–±ç‡ï¼‰', 
                    hue='LP_View_Rate', palette='RdYlGn', size='CPMï¼ˆæ¯åƒæ¬¡å»£å‘Šæ›å…‰æˆæœ¬ï¼‰', sizes=(20, 200))
    plt.axhline(y=1.5, color='orange', linestyle='--', label='Low CTR Alert (1.5%)')
    plt.title('å±•ç¤ºèˆ‡ CTR åˆ†å¸ƒ (å³ä¸‹è§’ç‚ºçŒæ°´é«˜é¢¨éšªå€)')
    plt.legend()

    plt.tight_layout()
    plt.savefig('ad_anomaly_report.png')
    print("\nâœ… è¦–è¦ºåŒ–åœ–è¡¨å·²ä¿å­˜ç‚º 'ad_anomaly_report.png'")

# --- ä½¿ç”¨æ–¹å¼ ---
# è«‹å°‡ 'åˆ†æç”¨20251119.csv' æ›¿æ›æˆæ‚¨å¯¦éš›çš„æª”æ¡ˆåç¨±
if __name__ == "__main__":
    file_name = 'åˆ†æç”¨20251119.csv' 
    detect_anomalies(file_name)
